<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Simulation 2025</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'cinzel': ['Cinzel', 'serif'],
                        'rajdhani': ['Rajdhani', 'sans-serif'],
                    },
                    colors: {
                        'obsidian': '#050505',
                        'charcoal': '#0a0a0a',
                        'gold': '#d4af37',
                        'neon-lime': '#cfff04',
                        'crimson': '#ff003c',
                        'glass': 'rgba(255, 255, 255, 0.03)'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            color: #e2e8f0;
            overflow-x: hidden;
            background-image:
                radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.05), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(255, 0, 60, 0.03), transparent 25%);
        }

        /* Ambient Noise Texture */
        .noise-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 0;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #cfff04;
        }

        /* Animations */
        @keyframes slideUpFade {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .row-animate {
            animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }

        .shimmer {
            position: relative;
            overflow: hidden;
        }

        .shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0,
                    rgba(255, 255, 255, 0.05) 20%,
                    rgba(255, 255, 255, 0.1) 60%,
                    rgba(255, 255, 255, 0));
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        /* Glass Panel */
        .glass-panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        /* Hover Glow */
        .hover-glow:hover {
            box-shadow: 0 0 20px rgba(207, 255, 4, 0.15);
            border-color: rgba(207, 255, 4, 0.3);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(5, 5, 5, 0.8);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .bar-chart-container {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 150px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bar-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            height: 100%;
            position: relative;
        }

        .bar-val {
            background: #fff;
            width: 100%;
            border-radius: 2px 2px 0 0;
            min-height: 2px;
            transition: height 0.5s ease;
            position: relative;
        }

        .bar-label {
            font-size: 8px;
            position: absolute;
            bottom: -18px;
            color: rgba(255, 255, 255, 0.4);
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 0.5rem;
        }
    </style>
</head>

<body class="font-rajdhani selection:bg-neon-lime selection:text-black">
    <div class="noise-bg"></div>

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-50 glass-panel border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <a href="index.html"
                class="font-cinzel font-bold text-xl tracking-widest text-white hover:opacity-80 transition-opacity">
                MARACANIA<span class="text-neon-lime">.AI</span>
            </a>
            <div class="flex items-center gap-4 md:gap-6">
                <div class="flex gap-1 overflow-x-auto no-scrollbar max-w-[40vw] md:max-w-none" id="league-nav">
                    <!-- Nav Items Injected Here -->
                </div>
                <div class="hidden md:block h-6 w-px bg-white/10"></div>
                <a href="methodology.html"
                    class="text-[10px] md:text-xs font-bold tracking-widest uppercase text-white/50 hover:text-neon-lime transition-colors whitespace-nowrap">
                    Methodology
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="relative z-10 pt-24 pb-12 px-4 max-w-7xl mx-auto min-h-screen flex flex-col">

        <!-- Hero Section -->
        <header id="hero-section" class="mb-12 mt-8 animate-[slideUpFade_0.8s_ease-out_forwards]">
            <!-- Injected Hero Content -->
            <div class="text-center">
                <div
                    class="inline-block px-3 py-1 border border-white/10 rounded-full text-xs font-bold tracking-[0.2em] text-white/50 mb-4 uppercase">
                    Season 2024/2025 Prediction
                </div>
                <h1 class="font-cinzel text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-600 tracking-tighter mb-2"
                    id="league-title">
                    LOADING
                </h1>
            </div>
        </header>

        <!-- Match Prediction Center -->
        <div id="match-center-container" class="mb-16 hidden animate-[slideUpFade_0.9s_ease-out_forwards]">
            <div class="flex items-center gap-4 mb-4 px-2">
                <div class="h-px bg-white/10 flex-1"></div>
                <span class="text-neon-lime text-xs font-bold tracking-[0.2em] uppercase">Next Matchday
                    Predictions</span>
                <div class="h-px bg-white/10 flex-1"></div>
            </div>
            <div class="flex gap-4 overflow-x-auto pb-4 no-scrollbar" id="match-center-scroll">
                <!-- Matches Injected Here -->
            </div>
        </div>

        <!-- Standings Grid -->
        <div class="w-full">
            <!-- Table Header -->
            <div
                class="grid grid-cols-12 gap-4 px-6 py-3 text-xs font-bold tracking-widest text-white/30 uppercase border-b border-white/5 mb-2">
                <div class="col-span-1 text-center">#</div>
                <div class="col-span-4 md:col-span-3">Club</div>
                <div class="col-span-2 text-center text-neon-lime">Win %</div>
                <div class="col-span-2 text-center text-blue-400">UCL %</div>
                <div class="col-span-2 text-center text-red-500 hidden md:block">Rel %</div>
                <div class="col-span-3 md:col-span-2 text-right">Exp. Pts</div>
            </div>

            <div id="results-grid" class="space-y-1">
                <!-- Rows Injected Here -->
            </div>
        </div>

    </main>

    <!-- Team Details Modal -->
    <div id="team-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content glass-panel w-full max-w-2xl mx-4 rounded-xl p-6 md:p-8 relative border border-white/10 shadow-2xl bg-[#050505]/90"
            onclick="event.stopPropagation()">
            <!-- Close Button -->
            <button onclick="closeModal()"
                class="absolute top-4 right-4 text-white/30 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>

            <!-- Modal Header -->
            <div class="flex items-center gap-4 mb-8">
                <div>
                    <div class="text-neon-lime text-xs font-bold tracking-widest uppercase mb-1">Team Analysis</div>
                    <h2 id="modal-team-name" class="text-4xl font-cinzel font-bold text-white leading-none">Team Name
                    </h2>
                </div>
                <div class="ml-auto text-right">
                    <div id="modal-points" class="text-3xl font-bold text-white">00.0</div>
                    <div class="text-xs text-white/40 uppercase tracking-wider">Avg Points</div>
                </div>
            </div>

            <!-- Ratings Section -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="stat-card">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-white/60 text-xs font-bold uppercase tracking-wider">Attack Rating</span>
                        <span id="modal-att-val" class="text-neon-lime font-mono font-bold text-xl">0.0</span>
                    </div>
                    <div class="h-1 bg-white/10 rounded-full overflow-hidden">
                        <div id="modal-att-bar" class="h-full bg-neon-lime transition-all duration-1000"
                            style="width: 0%"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-white/60 text-xs font-bold uppercase tracking-wider">Defense Rating</span>
                        <span id="modal-def-val" class="text-blue-400 font-mono font-bold text-xl">0.0</span>
                    </div>
                    <div class="h-1 bg-white/10 rounded-full overflow-hidden">
                        <div id="modal-def-bar" class="h-full bg-blue-400 transition-all duration-1000"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Insights Section -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div id="modal-run-in-card"
                    class="stat-card group cursor-pointer hover:bg-white/5 transition-colors relative overflow-hidden"
                    onclick="toggleRunIn()">
                    <div
                        class="absolute inset-0 bg-neon-lime/0 group-hover:bg-neon-lime/5 transition-colors duration-500">
                    </div>
                    <div class="flex flex-col h-full justify-between relative z-10">
                        <div class="flex justify-between items-start">
                            <div class="text-white/60 text-xs font-bold uppercase tracking-wider mb-2">Run-In Difficulty
                            </div>
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round"
                                class="text-white/30 group-hover:text-neon-lime transition-colors transform group-hover:translate-y-0.5">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </div>
                        <div class="flex items-end gap-2">
                            <span id="modal-sos-val" class="text-2xl font-bold text-white">5.0</span>
                            <span id="modal-sos-text"
                                class="text-xs uppercase font-bold text-white/50 mb-1">Average</span>
                        </div>
                        <div class="h-1 bg-white/10 rounded-full overflow-hidden mt-2">
                            <div id="modal-sos-bar" class="h-full bg-white transition-all duration-1000"
                                style="width: 50%"></div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="flex flex-col h-full justify-between">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="text-white/60 text-xs font-bold uppercase tracking-wider">Performance</div>
                            <div class="group relative flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round"
                                    class="text-white/40 cursor-help hover:text-white transition-colors">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                                <div
                                    class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 p-2 bg-[#0a0a0a] border border-white/10 rounded shadow-xl text-[10px] text-white/80 leading-relaxed opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 glass-panel">
                                    Compares actual rank vs expected rank based on Squad Quality (Attack + Def).
                                    Positive = Overperforming.
                                </div>
                            </div>
                        </div>
                        <div class="flex items-end gap-2">
                            <div id="modal-perf-val" class="text-2xl font-bold text-green-400">+0</div>
                            <span class="text-xs uppercase font-bold text-white/50 mb-1">vs Expected</span>
                        </div>
                        <div id="modal-perf-text" class="text-[10px] text-white/40 mt-2 leading-tight">
                            performing as expected based on squad quality.
                        </div>
                    </div>
                </div>
            </div>

            <!-- The Run-In Section (New) -->
            <div id="modal-run-in-container" class="mb-8 hidden">
                <div class="text-white/60 text-xs font-bold uppercase tracking-wider mb-4 border-b border-white/5 pb-2">
                    Next 5 Opponents</div>
                <div id="modal-run-in-list" class="space-y-2">
                    <!-- Opponents injected here -->
                </div>
            </div>

            <!-- Position Distribution Chart -->
            <div class="stat-card">
                <div class="text-white/60 text-xs font-bold uppercase tracking-wider mb-4 border-b border-white/5 pb-2">
                    Final Position Probabilities</div>
                <div id="modal-chart" class="bar-chart-container">
                    <!-- Bars injected here -->
                </div>
            </div>

        </div>
    </div>

    <script src="simulation_data.js"></script>
    <script>
        // State
        let currentLeague = 'La Liga';
        let currentFilter = 'WIN'; // WIN, UCL, UEL, UECL, REL

        const FILTERS = {
            'WIN': { label: 'Winner', color: 'text-neon-lime', barColor: 'bg-neon-lime' },
            'UCL': { label: 'Champions League', color: 'text-blue-400', barColor: 'bg-blue-500' },
            'UEL': { label: 'Europa League', color: 'text-orange-400', barColor: 'bg-orange-500' },
            'UECL': { label: 'Conference', color: 'text-green-400', barColor: 'bg-green-500' },
            'REL': { label: 'Relegation', color: 'text-red-500', barColor: 'bg-red-500' }
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof simulationResults !== 'undefined') {
                const leagues = Object.keys(simulationResults).filter(key => !key.endsWith('_upcoming'));
                renderNav(leagues);
                renderFilters();
                if (leagues.includes('La Liga')) selectLeague('La Liga');
                else if (leagues.length > 0) selectLeague(leagues[0]);
            }
        });

        function renderNav(leagues) {
            const nav = document.getElementById('league-nav');

            nav.innerHTML = leagues.map(league => `
                <button onclick="selectLeague('${league}')" 
                    id="nav-${league.replace(/\s+/g, '-')}"
                    class="px-4 py-2 text-sm font-semibold tracking-wide text-white/50 hover:text-white transition-colors uppercase border-b-2 border-transparent">
                    ${league}
                </button>
            `).join('');
        }

        function renderFilters() {
            const container = document.createElement('div');
            container.className = 'flex justify-center gap-2 mb-8 animate-[slideUpFade_0.9s_ease-out_forwards]';
            container.id = 'filter-container';

            const filterKeys = ['WIN', 'UCL', 'UEL', 'UECL', 'REL']; // Order

            container.innerHTML = filterKeys.map(key => `
                <button onclick="selectFilter('${key}')" 
                    id="filter-${key}"
                    class="px-3 py-1 text-xs font-bold tracking-widest border border-white/10 rounded-full transition-all duration-300 hover:bg-white/10 ${key === currentFilter ? 'bg-white/10 text-white shadow-[0_0_15px_rgba(255,255,255,0.1)]' : 'text-white/40'}">
                    ${FILTERS[key].label.toUpperCase()}
                </button>
            `).join('');

            // Insert after header
            const header = document.getElementById('hero-section');
            header.after(container);
        }

        function selectFilter(filterKey) {
            currentFilter = filterKey;

            // Update buttons
            document.querySelectorAll('#filter-container button').forEach(btn => {
                btn.classList.remove('bg-white/10', 'text-white', 'shadow-[0_0_15px_rgba(255,255,255,0.1)]');
                btn.classList.add('text-white/40');
            });
            const active = document.getElementById(`filter-${filterKey}`);
            if (active) {
                active.classList.remove('text-white/40');
                active.classList.add('bg-white/10', 'text-white', 'shadow-[0_0_15px_rgba(255,255,255,0.1)]');
            }

            // Re-render grid
            const data = simulationResults[currentLeague];
            if (data) renderGrid(data);
        }

        function selectLeague(leagueName) {
            currentLeague = leagueName;

            // Update Nav Active State
            document.querySelectorAll('#league-nav button').forEach(btn => {
                btn.classList.remove('text-white', 'border-neon-lime');
                btn.classList.add('text-white/50', 'border-transparent');
            });
            const activeBtn = document.getElementById(`nav-${leagueName.replace(/\s+/g, '-')}`);
            if (activeBtn) {
                activeBtn.classList.add('text-white', 'border-neon-lime');
                activeBtn.classList.remove('text-white/50', 'border-transparent');
            }

            // Update Title
            const titleEl = document.getElementById('league-title');
            titleEl.style.opacity = 0;
            setTimeout(() => {
                titleEl.textContent = leagueName.toUpperCase();
                titleEl.style.opacity = 1;
            }, 200);

            // Render content
            const data = simulationResults[leagueName];
            const matches = simulationResults[leagueName + "_upcoming"];
            if (data) {
                renderHero(data);
                renderGrid(data);
                renderMatchCenter(matches);
            }
        }



        function renderMatchCenter(matches) {
            const container = document.getElementById('match-center-container');
            const scroll = document.getElementById('match-center-scroll');

            if (!matches || matches.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            scroll.innerHTML = matches.map(m => `
                <div class="glass-panel p-4 rounded-lg min-w-[280px] border border-white/5 flex flex-col justify-between hover:border-white/20 transition-colors cursor-default">
                    <div class="flex justify-between items-center text-[10px] text-white/40 uppercase font-bold tracking-widest mb-3">
                        <span>Match Prediction</span>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-center w-1/3">
                            <div class="text-sm font-bold text-white leading-tight mb-1">${m.home_team}</div>
                            <div class="text-xs text-neon-lime">${m.home_win_prob}%</div>
                        </div>
                        <div class="text-xs font-mono text-white/30">VS</div>
                        <div class="text-center w-1/3">
                            <div class="text-sm font-bold text-white leading-tight mb-1">${m.away_team}</div>
                            <div class="text-xs text-red-500">${m.away_win_prob}%</div>
                        </div>
                    </div>

                    <div class="w-full h-1.5 bg-white/5 rounded-full overflow-hidden flex">
                        <div class="h-full bg-neon-lime" style="width: ${m.home_win_prob}%"></div>
                        <div class="h-full bg-white/20" style="width: ${m.draw_prob}%"></div>
                        <div class="h-full bg-red-600" style="width: ${m.away_win_prob}%"></div>
                    </div>
                    <div class="flex justify-between mt-1 text-[9px] text-white/30 font-mono">
                        <span>1</span>
                        <span>X</span>
                        <span>2</span>
                    </div>
                </div>
            `).join('');
        }

        function renderHero(data) {
            // Find winner
            const winner = data.reduce((prev, current) => (prev.win_probability > current.win_probability) ? prev : current);
        }

        function getColumnsForFilter(filter) {
            switch (filter) {
                case 'WIN': return [
                    { key: 'win_probability', label: 'Win %', color: 'text-neon-lime' },
                    { key: 'top4_probability', label: 'UCL %', color: 'text-blue-400' },
                    { key: 'relegation_probability', label: 'Rel %', color: 'text-red-500' }
                ];
                case 'UCL': return [
                    { key: 'top4_probability', label: 'UCL %', color: 'text-blue-400' },
                    { key: 'win_probability', label: 'Win %', color: 'text-neon-lime' },
                    { key: 'uel_probability', label: 'UEL %', color: 'text-orange-400' }
                ];
                case 'UEL': return [
                    { key: 'uel_probability', label: 'UEL %', color: 'text-orange-400' },
                    { key: 'top4_probability', label: 'UCL %', color: 'text-blue-400' },
                    { key: 'uecl_probability', label: 'UECL %', color: 'text-green-400' }
                ];
                case 'UECL': return [
                    { key: 'uecl_probability', label: 'UECL %', color: 'text-green-400' },
                    { key: 'uel_probability', label: 'UEL %', color: 'text-orange-400' },
                    { key: 'relegation_probability', label: 'Rel %', color: 'text-red-500' }
                ];
                case 'REL': return [
                    { key: 'relegation_probability', label: 'Rel %', color: 'text-red-500' },
                    { key: 'safe_probability', label: 'Safe %', color: 'text-green-400' }, // Custom calculation
                    { key: 'win_probability', label: 'Win %', color: 'text-white/20' }
                ];
                default: return [];
            }
        }

        function renderGrid(data) {
            const grid = document.getElementById('results-grid');

            // 1. Update Header
            const cols = getColumnsForFilter(currentFilter);
            const headerHTML = `
                <div class="grid grid-cols-12 gap-4 px-6 py-3 text-xs font-bold tracking-widest text-white/30 uppercase border-b border-white/5 mb-2">
                    <div class="col-span-1 text-center">#</div>
                    <div class="col-span-4 md:col-span-3">Club</div>
                    <div class="col-span-2 text-center ${cols[0].color}">${cols[0].label}</div>
                    <div class="col-span-2 text-center ${cols[1].color}">${cols[1].label}</div>
                    <div class="col-span-2 text-center ${cols[2].color} hidden md:block">${cols[2].label}</div>
                    <div class="col-span-3 md:col-span-2 text-right">Exp. Pts</div>
                </div>
            `;

            // Replace the previous header if it exists inside the grid container or just prepend?
            // Actually the header is OUTSIDE the 'results-grid' div in the HTML structure.
            // Let's target the sibling before results-grid.
            const headerEl = grid.previousElementSibling;
            if (headerEl) headerEl.outerHTML = headerHTML;


            grid.innerHTML = '';

            // Sort data based on the Active Filter Metric
            const sortedData = [...data].sort((a, b) => {
                // Primary sort: The selected filter metric
                const key = cols[0].key;
                let valA = a[key];
                let valB = b[key];

                // Special handling for 'safe_probability'
                if (key === 'safe_probability') {
                    valA = 100 - a.relegation_probability;
                    valB = 100 - b.relegation_probability;
                }

                // Secondary sort: Points (tie breaker)
                if (valA !== valB) return valB - valA;
                return b.avg_points - a.avg_points;
            });

            // Wait, usually standings are sorted by POINTS. 
            // If I filter by "Relegation", should the list reorder to show high relegation prob first?
            // "The user should be able to select if he wants to calculate de probability of..."
            // Usually these tools just change the columns, but KEEP the ranking by POINTS (official table order).
            // HOWEVER, if I want to see "Who is most likely to win", sorting by Win % makes sense (which usually aligns with points).
            // If I want to see "Who is most likely to relegate", I probably want to see the bottom teams.
            // Let's stick to Points Ordering for stability, but maybe the visual bars help you spot them.
            // Actually, let's keep the standard table order (avg_points). It's less confusing than rows jumping around.
            // The user asked to "Classify" which might imply sorting, but "Table" implies points. 
            // Let's stick to the original order (data is passed in sorted by points from Python usually, or we sort by points).
            const dataByPoints = [...data].sort((a, b) => b.avg_points - a.avg_points);

            dataByPoints.forEach((team, index) => {
                const rank = index + 1;
                const delay = index * 0.05; // Stagger effect

                // Styling logic based on RANK (not probability) for the row background
                // We keep the "Qualification Zone" styling based on rank (Realism)
                let rowBg = 'hover:bg-white/5';
                let rankColor = 'text-white/40';

                const isUCL = rank <= 4;
                const isRelegation = rank > data.length - 3;

                if (rank === 1) {
                    rankColor = 'text-neon-lime';
                    rowBg = 'bg-gradient-to-r from-neon-lime/10 to-transparent border border-neon-lime/20';
                } else if (isUCL) {
                    rankColor = 'text-blue-400';
                    rowBg = 'bg-blue-500/5 hover:bg-blue-500/10 border-l-2 border-l-blue-500';
                } else if (isRelegation) {
                    rankColor = 'text-red-500';
                    rowBg = 'bg-red-500/5 hover:bg-red-500/10 border-l-2 border-l-red-500';
                }

                const el = document.createElement('div');
                el.className = `grid grid-cols-12 gap-4 px-6 py-4 items-center rounded-lg border border-transparent transition-all duration-300 row-animate group cursor-pointer ${rowBg}`;
                el.style.animationDelay = `${delay}s`;
                el.onclick = () => openTeamDetails(team.team_name);

                // Calculate Values for Columns
                const getVal = (key) => {
                    if (key === 'safe_probability') return (100 - team.relegation_probability).toFixed(1);
                    return team[key];
                };

                const val1 = getVal(cols[0].key);
                const val2 = getVal(cols[1].key);
                const val3 = getVal(cols[2].key);

                // Bar Width (Primary Metric)
                const barWidth = Math.max(0, parseFloat(val1));
                const activeBarColor = FILTERS[currentFilter].barColor;

                el.innerHTML = `
                    <div class="col-span-1 text-center font-cinzel font-bold text-xl ${rankColor}">${rank}</div>
                    <div class="col-span-4 md:col-span-3 flex flex-col justify-center">
                        <span class="text-lg md:text-xl font-bold tracking-tight text-white group-hover:tracking-wide transition-all">${team.team_name}</span>
                        <div class="h-0.5 w-full bg-white/5 mt-1 rounded-full overflow-hidden">
                            <div class="h-full ${activeBarColor} transition-all duration-1000" style="width: ${barWidth}%"></div>
                        </div>
                    </div>
                    
                    <div class="col-span-2 text-center font-mono text-lg ${parseFloat(val1) > 0 ? cols[0].color + ' font-bold' : 'text-white/20'}">
                        ${parseFloat(val1) > 0 ? val1 + '%' : '-'}
                    </div>
                    
                    <div class="col-span-2 text-center font-mono text-base ${parseFloat(val2) > 0 ? cols[1].color : 'text-white/20'}">
                        ${parseFloat(val2) > 0 ? val2 + '%' : '-'}
                    </div>

                    <div class="col-span-2 text-center font-mono text-base hidden md:block ${parseFloat(val3) > 0 ? cols[2].color : 'text-white/20'}">
                        ${parseFloat(val3) > 0 ? val3 + '%' : '-'}
                    </div>

                    <div class="col-span-3 md:col-span-2 text-right">
                        <span class="text-2xl font-bold text-white">${team.avg_points}</span>
                        <span class="text-xs text-white/40 block uppercase tracking-wider">PTS</span>
                    </div>
                `;

                grid.appendChild(el);
            });
        }

        // --- Team Details Modal Logic ---
        function openTeamDetails(teamName) {
            const leagueData = simulationResults[currentLeague];
            const team = leagueData.find(t => t.team_name === teamName);
            if (!team) return;

            // Populate Info
            document.getElementById('modal-team-name').textContent = team.team_name;
            document.getElementById('modal-points').textContent = team.avg_points.toFixed(1);

            // Populate Ratings
            document.getElementById('modal-att-val').textContent = team.attack_rating;
            document.getElementById('modal-def-val').textContent = team.defense_rating;
            document.getElementById('modal-att-bar').style.width = `${(team.attack_rating / 10) * 100}%`;
            document.getElementById('modal-def-bar').style.width = `${(team.defense_rating / 10) * 100}%`;

            // Populate Insights (SoS & Delta) IF they exist (they should after update)
            if (team.strength_of_schedule !== undefined) {
                // Strength of Schedule
                const sos = team.strength_of_schedule;
                document.getElementById('modal-sos-val').textContent = sos.toFixed(1);

                let sosText = 'Average';
                let sosColor = 'bg-white';

                // Scale 0-10. 5 is Avg. >5 Hard, <5 Easy.
                if (sos > 6.5) { sosText = 'Nightmare'; sosColor = 'bg-red-500'; }
                else if (sos > 5.5) { sosText = 'Hard'; sosColor = 'bg-orange-500'; }
                else if (sos < 3.5) { sosText = 'Walk in Park'; sosColor = 'bg-green-500'; }
                else if (sos < 4.5) { sosText = 'Favorable'; sosColor = 'bg-neon-lime'; }

                const sosTextEl = document.getElementById('modal-sos-text');
                const matches = team.matches_remaining || 0;
                sosTextEl.textContent = `${sosText} (${matches} Match${matches !== 1 ? 'es' : ''})`;

                // Color Logic for Text (Remove bg-, add text-)
                const textColor = sosColor.replace('bg-', 'text-');
                sosTextEl.className = `text-xs uppercase font-bold mb-1 ${textColor}`;

                const sosBar = document.getElementById('modal-sos-bar');
                sosBar.className = `h-full transition-all duration-1000 ${sosColor}`;
                sosBar.style.width = `${(sos / 10) * 100}%`;

                // Performance Delta
                const delta = team.performance_delta;
                const perfVal = document.getElementById('modal-perf-val');
                const perfText = document.getElementById('modal-perf-text');

                if (delta > 0) {
                    perfVal.textContent = `+${delta}`;
                    perfVal.className = 'text-2xl font-bold text-neon-lime';
                    perfText.innerHTML = `Overperforming by <span class="text-white font-bold">${delta}</span> positions vs stats model.`;
                } else if (delta < 0) {
                    perfVal.textContent = `${delta}`;
                    perfVal.className = 'text-2xl font-bold text-red-500';
                    perfText.innerHTML = `Underperforming by <span class="text-white font-bold">${Math.abs(delta)}</span> positions vs stats model.`;
                } else {
                    perfVal.textContent = '-';
                    perfVal.className = 'text-2xl font-bold text-white/50';
                    perfText.textContent = 'Performing exactly as expected based on squad metrics.';
                }
            }

            // Populate Run-In (New)
            const runInContainer = document.getElementById('modal-run-in-container');
            const runInList = document.getElementById('modal-run-in-list');

            // Quick Reset of Container Visibility to HIDDEN every time modal opens
            runInContainer.classList.add('hidden');

            if (team.next_opponents && team.next_opponents.length > 0) {
                // Determine if we should enable the click on the card
                const card = document.getElementById('modal-run-in-card');
                if (card) {
                    card.style.pointerEvents = 'auto'; // Enable click
                    card.style.opacity = '1';
                }

                runInList.innerHTML = team.next_opponents.map(opp => {
                    // Difficulty Color
                    let diffColor = 'bg-white/20';
                    let diffText = 'text-white/40';
                    if (opp.difficulty > 7) { diffColor = 'bg-red-500'; diffText = 'text-red-500'; }
                    else if (opp.difficulty > 5.5) { diffColor = 'bg-orange-500'; diffText = 'text-orange-500'; }
                    else if (opp.difficulty < 3.5) { diffColor = 'bg-green-500'; diffText = 'text-green-500'; }
                    else if (opp.difficulty < 4.5) { diffColor = 'bg-neon-lime'; diffText = 'text-neon-lime'; }

                    return `
                        <div class="flex items-center gap-3 p-2 bg-white/5 rounded border border-white/5">
                            <div class="w-1 h-8 rounded-full ${diffColor}"></div>
                            <div class="flex-1">
                                <div class="text-sm font-bold text-white">${opp.opponent}</div>
                                <div class="text-[10px] uppercase tracking-wider text-white/30">${opp.is_home ? 'Home' : 'Away'}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-mono font-bold ${diffText}">${opp.difficulty}</div>
                                <div class="text-[9px] uppercase tracking-wider text-white/20">Diff</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                runInContainer.classList.add('hidden');
                const card = document.getElementById('modal-run-in-card');
                if (card) {
                    card.style.pointerEvents = 'none'; // Disable click
                }
            }

            // Populate Chart
            const chartContainer = document.getElementById('modal-chart');
            const numTeams = leagueData.length;
            const positions = team.position_distribution.slice(0, numTeams);

            // Generate Bars
            chartContainer.innerHTML = positions.map((prob, idx) => {
                const rank = idx + 1;
                let barColor = 'bg-white/20';

                // Color Logic
                if (rank === 1) barColor = 'bg-neon-lime';
                else if (rank <= 4) barColor = 'bg-blue-500';
                else if (rank === 5 || rank === 6) barColor = 'bg-orange-500';
                else if (rank === 7) barColor = 'bg-green-500'; // UECL depending on league size, rough approx
                else if (rank > numTeams - 3) barColor = 'bg-red-500';

                // Opacity based on value? No, use height
                const height = Math.max(1, prob); // Ensure at least a sliver

                return `
                    <div class="bar-col group relative" title="Rank ${rank}: ${prob}%">
                        <div class="bar-val ${barColor}" style="height: ${prob}%"></div>
                        <div class="bar-label opacity-0 group-hover:opacity-100 transition-opacity">${rank}</div>
                        ${prob > 5 ? `<div class="absolute bottom-1 w-full text-center text-[8px] font-bold text-black/80 pointer-events-none">${Math.round(prob)}</div>` : ''}
                    </div>
                `;
            }).join('');

            // Open Modal
            document.getElementById('team-modal').classList.add('active');
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return; // Only if clicking overlay
            document.getElementById('team-modal').classList.remove('active');
            // Reset run-in view for next time
            document.getElementById('modal-run-in-container').classList.add('hidden');
        }

        function toggleRunIn() {
            const container = document.getElementById('modal-run-in-container');
            container.classList.toggle('hidden');
        }

    </script>
</body>

</html>